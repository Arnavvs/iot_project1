<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>pH Monitoring Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #121212;
      color: #fff;
    }

    header {
      background-color: #1f1f1f;
      padding: 20px;
      text-align: center;
    }

    h1 {
      margin: 0;
      color: #8b5cf6;
    }

    .container {
      padding: 20px;
    }

    .chart-container {
      background-color: #1e1e1e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }

    input, button {
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
    }

    input[type="number"], input[type="email"], input[type="date"] {
      width: 180px;
    }

    button {
      background-color: #8b5cf6;
      color: white;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #1e1e1e;
    }

    th, td {
      padding: 10px;
      border: 1px solid #333;
      text-align: left;
      color: #ccc;
    }

    th {
      background-color: #2a2a2a;
    }

    #downloadBtn {
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Water pH Monitoring Dashboard</h1>
  </header>

  <div class="container">
    <div class="controls">
      <input type="date" id="datePicker" />
      <input type="number" id="minPH" placeholder="Enter Min pH" />
      <input type="number" id="maxPH" placeholder="Enter Max pH" />
      <input type="email" id="userEmail" placeholder="Enter your Email" />
      <button onclick="setAlertTrigger()">Set Alert Trigger</button>
      <button id="downloadBtn">Download CSV</button>
    </div>

    <div class="chart-container">
      <canvas id="phChart" height="100"></canvas>
    </div>

    <h3>Data Table</h3>
    <table id="dataTable">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>pH Value</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <script>
    const channelID = 2454679;
    const readAPIKey = "0UN888059PJ9KW30";

    let minPH = null;
    let maxPH = null;
    let email = "";

    const ctx = document.getElementById("phChart").getContext("2d");
    const phChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'pH Level',
          borderColor: '#8b5cf6',
          backgroundColor: 'rgba(139, 92, 246, 0.2)',
          data: [],
          fill: true,
          tension: 0.4,
        }]
      },
      options: {
        scales: {
          x: {
            type: 'time',
            time: {
              tooltipFormat: 'HH:mm',
              unit: 'hour',
              displayFormats: { hour: 'HH:mm' }
            },
            title: {
              display: true,
              text: 'Time',
              color: '#fff'
            },
            ticks: {
              color: '#ccc'
            }
          },
          y: {
            title: {
              display: true,
              text: 'pH Level',
              color: '#fff'
            },
            min: 0,
            max: 14,
            ticks: {
              color: '#ccc'
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: '#fff'
            }
          }
        }
      }
    });

    async function fetchData() {
      const url = `https://api.thingspeak.com/channels/${channelID}/fields/1.json?results=9999`;
      const response = await fetch(url);
      const data = await response.json();
      const feeds = data.feeds;

      const selectedDate = document.getElementById("datePicker").value;
      const filteredFeeds = selectedDate
        ? feeds.filter(feed => feed.created_at.startsWith(selectedDate))
        : feeds;

      const times = filteredFeeds.map(feed => feed.created_at);
      const values = filteredFeeds.map(feed => parseFloat(feed.field1));

      phChart.data.labels = times;
      phChart.data.datasets[0].data = values;
      phChart.update();

      // Update table
      const tableBody = document.querySelector("#dataTable tbody");
      tableBody.innerHTML = "";
      filteredFeeds.forEach(feed => {
        const row = `<tr><td>${feed.created_at}</td><td>${feed.field1}</td></tr>`;
        tableBody.innerHTML += row;
      });

      // Check alert
      const latestPH = parseFloat(feeds[feeds.length - 1].field1);
      if (minPH !== null && maxPH !== null && email !== "") {
        if (latestPH < minPH || latestPH > maxPH) {
          sendEmailAlert(latestPH);
        }
      }
    }

    function setAlertTrigger() {
      minPH = parseFloat(document.getElementById("minPH").value);
      maxPH = parseFloat(document.getElementById("maxPH").value);
      email = document.getElementById("userEmail").value;

      alert("Alert trigger set!");
    }

    function sendEmailAlert(value) {
      console.log(`Email alert to ${email}: pH level is ${value}`);
      // Implement backend email service if needed
    }

    // Download CSV
    document.getElementById("downloadBtn").addEventListener("click", () => {
      const rows = [["Timestamp", "pH Value"]];
      const tableRows = document.querySelectorAll("#dataTable tbody tr");
      tableRows.forEach(row => {
        const cols = row.querySelectorAll("td");
        rows.push([cols[0].innerText, cols[1].innerText]);
      });

      let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "ph_data.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    document.getElementById("datePicker").addEventListener("change", fetchData);

    // Refresh data every 15 seconds
    setInterval(fetchData, 15000);
    fetchData();
  </script>
</body>
</html>
